<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vale para Daniela ‚ú®</title>

  <!-- Tipos bonitos (fallback si no cargan) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#12050b;
      --muted:#7b3a55;
      --accent:#ff2d6d;
      --accent2:#ff8fb2;

      --glass: rgba(255,255,255,0.68);
      --stroke: rgba(255, 180, 200, 0.55);
      --shadow: 0 26px 70px rgba(255, 45, 109, 0.16);
      --radius: 28px;

      --bgOverlay1: rgba(255, 240, 246, 0.68);
      --bgOverlay2: rgba(255, 248, 252, 0.78);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow-x:hidden;
      display:grid;
      place-items:center;
      padding: 22px;
      background: #fff7fb; /* fallback */
    }

    /* Fondo con imagen difuminada */
    .bg{
      position: fixed;
      inset: 0;
      z-index: -2;
      background-image: url("YOUR_IMAGE_URL_HERE"); /* <-- CAMBIA ESTO */
      background-size: cover;
      background-position: center;
      filter: blur(18px);
      transform: scale(1.12);
    }

    /* Overlay suave para legibilidad */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(900px 520px at 10% 12%, rgba(255, 205, 225, 0.50) 0%, transparent 55%),
        radial-gradient(800px 520px at 90% 18%, rgba(255, 225, 240, 0.55) 0%, transparent 60%),
        linear-gradient(180deg, var(--bgOverlay2), var(--bgOverlay1));
    }

    /* Grano tipo papel (muy sutil) */
    .overlay:before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background-image: radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px);
      background-size: 18px 18px;
      opacity:0.35;
      mix-blend-mode:multiply;
    }

    .page{
      width: min(860px, 100%);
      border-radius: var(--radius);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position: relative;
    }

    .page::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(90deg, rgba(255,45,109,0.22), rgba(255,143,178,0.14)),
        radial-gradient(500px 240px at 50% -10%, rgba(255,255,255,0.55), transparent 65%);
      opacity:0.55;
      mix-blend-mode:soft-light;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px 0;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .brand h1{
      margin:0;
      font-family: Fraunces, ui-serif, Georgia, serif;
      font-size: 1.25rem;
      letter-spacing: 0.2px;
    }

    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.72);
      padding: 9px 12px;
      color: var(--muted);
      font-size: 0.92rem;
      user-select:none;
      white-space:nowrap;
    }

    .dotHeart{
      width:10px; height:10px;
      background: var(--accent);
      transform: rotate(45deg);
      border-radius: 2px;
      position: relative;
      box-shadow: 0 0 0 6px rgba(255,45,109,0.10);
      animation: pulse 1.7s ease-in-out infinite;
    }
    .dotHeart:before,.dotHeart:after{
      content:"";
      position:absolute;
      width:10px; height:10px;
      background: var(--accent);
      border-radius:50%;
    }
    .dotHeart:before{ left:-5px; top:0; }
    .dotHeart:after{ top:-5px; left:0; }

    @keyframes pulse{
      0%,100%{ transform: rotate(45deg) scale(1); }
      50%{ transform: rotate(45deg) scale(1.08); }
    }

    .content{
      padding: 18px;
      position: relative;
      z-index: 1;
    }

    .center{
      display:grid;
      place-items:center;
      gap: 14px;
      padding: 12px 0 6px;
      text-align:center;
    }

    .heartCanvasWrap{
      width: min(320px, 70vw);
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
      border-radius: 26px;
      border: 1px solid rgba(255, 180, 200, 0.55);
      background: rgba(255,255,255,0.45);
      box-shadow: 0 12px 30px rgba(255,45,109,0.10);
      overflow:hidden;
    }

    canvas{ display:block; width:100%; height:100%; }

    .countdownBlock{
      display:grid;
      gap: 6px;
      margin-top: 6px;
    }

    .countdownTitle{
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 0.98rem;
    }

    .timer{
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.8px;
      font-weight: 900;
      font-size: 1.15rem;
      color: var(--ink);
    }

    .hint{
      color: var(--muted);
      font-size: 0.92rem;
      line-height: 1.4;
      margin: 0;
    }

    .divider{
      height:1px;
      width:100%;
      background: linear-gradient(90deg, transparent, rgba(255,45,109,0.35), transparent);
      margin: 16px 0;
    }

    .greeting{
      margin: 0;
      font-family: Fraunces, ui-serif, Georgia, serif;
      font-size: 1.85rem;
      line-height:1.1;
      letter-spacing: 0.2px;
    }
    .greeting .name{ color: var(--accent); }

    .box{
      width: min(560px, 100%);
      margin: 0 auto;
      display:grid;
      gap: 10px;
      text-align:left;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255, 180, 200, 0.55);
      background: rgba(255,255,255,0.62);
    }

    label{
      display:block;
      font-weight: 800;
      font-size: 0.92rem;
      margin-bottom: 6px;
    }

    input{
      width:100%;
      border: 1px solid rgba(255, 180, 200, 0.70);
      border-radius: 16px;
      padding: 12px 12px;
      outline:none;
      background:#fff;
      color: var(--ink);
      font-size: 1rem;
      transition: 0.15s ease;
    }

    input:focus{
      border-color: rgba(255,45,109,0.75);
      box-shadow: 0 0 0 5px rgba(255,45,109,0.10);
    }

    select{
      width:100%;
      border: 1px solid rgba(255, 180, 200, 0.70);
      border-radius: 16px;
      padding: 10px 12px;
      background:#fff;
      color: var(--ink);
      font-size: 0.95rem;
      transition: 0.15s ease;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-start;
    }

    .btn{
      border: 0;
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 0.98rem;
      user-select:none;
      transition: transform 0.14s ease, opacity 0.14s ease, box-shadow 0.14s ease;
    }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn[disabled]{ opacity:0.55; cursor:not-allowed; transform:none; }

    .btn-primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
      box-shadow: 0 12px 24px rgba(255,45,109,0.18);
    }

    .btn-ghost{
      background: rgba(255,255,255,0.75);
      color: var(--muted);
      border: 1px solid rgba(255, 180, 200, 0.70);
    }

    .error{
      margin: 4px 0 0;
      color:#b00020;
      font-size: 0.92rem;
    }

    .success{
      margin: 4px 0 0;
      color:#0f7b4a;
      font-size: 0.92rem;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,45,109,0.25);
      background: rgba(255,255,255,0.80);
      color: var(--muted);
      font-size: 0.88rem;
      user-select:none;
    }

    .coupon{
      display:none;
      padding: 14px;
      border-radius: 20px;
      border: 2px dashed rgba(255,45,109,0.65);
      background: rgba(255,255,255,0.92);
      animation: rise 0.35s ease-out;
      position: relative;
      overflow:hidden;
    }

    .coupon::before{
      content:"";
      position:absolute;
      inset:-50%;
      background: radial-gradient(closest-side, rgba(255,255,255,0.60), transparent 62%);
      transform: rotate(18deg);
      opacity:0.75;
      pointer-events:none;
    }

    @keyframes rise{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .coupon h2{
      margin: 0 0 6px;
      font-family: Fraunces, ui-serif, Georgia, serif;
      font-size: 1.18rem;
      color: var(--accent);
      position:relative;
      z-index:1;
    }

    .coupon p{
      margin:0;
      line-height:1.6;
      position:relative;
      z-index:1;
    }

    .fine{
      margin-top:10px;
      font-size:0.86rem;
      color:#8b7b82;
      position:relative;
      z-index:1;
    }

    /* Admin */
    .adminBar{
      display:flex;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .adminBtn{
      padding: 9px 12px;
      font-size: 0.9rem;
    }
    .adminPanel{
      display:none;
      margin-top: 12px;
      padding: 14px;
      border-radius: 20px;
      border: 1px dashed rgba(255,45,109,0.35);
      background: rgba(255,255,255,0.78);
      box-shadow: 0 10px 26px rgba(255,45,109,0.08);
    }
    .adminPanel .labelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .adminPanel .subgrid{
      display:grid;
      gap: 8px;
      margin-top: 6px;
    }

    /* Blackout + Loki */
    body.blackout{
      background: #000;
    }
    body.blackout .bg,
    body.blackout .overlay{
      opacity:0;
      transition: opacity 600ms ease;
    }
    .page.fadeOut{
      opacity:0;
      transform: scale(0.98);
      filter: blur(10px);
      transition: opacity 650ms ease, transform 650ms ease, filter 650ms ease;
      pointer-events:none;
    }
    .lokiOverlay{
      position: fixed;
      inset: 0;
      display:grid;
      place-items:center;
      opacity:0;
      pointer-events:none;
      background: rgba(0,0,0,0.98);
      transition: opacity 700ms ease;
      z-index: 999;
    }
    .lokiOverlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .lokiOverlay .mask{
      position: relative;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 50% 40%, rgba(0,0,0,0.65), rgba(0,0,0,0.98));
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    #pixelCanvas{
      width: 100%;
      height: 100%;
      display:block;
    }
    .lokiOverlay .label{
      position:absolute;
      bottom: 18px;
      left: 0; right:0;
      text-align:center;
      color:#c8d5e2;
      font-weight:800;
      letter-spacing:0.5px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    @media (prefers-reduced-motion: reduce){
      .dotHeart{ animation:none; }
      .btn{ transition:none; }
      .coupon{ animation:none; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <main class="page" role="main" aria-label="Vale para Daniela">
    <header class="topbar">
      <div class="brand">
        <h1 id="pageTitle">Un vale para Daniela ‚ú®</h1>
      </div>

      <div class="pill" aria-live="polite">
        <span class="dotHeart" aria-hidden="true"></span>
        <span id="pillText">Falta poquito‚Ä¶</span>
      </div>
    </header>

    <section class="content">
      <div class="center">
        <!-- Coraz√≥n pixelado -->
        <div class="heartCanvasWrap" aria-hidden="true">
          <canvas id="heartCanvas"></canvas>
        </div>

        <!-- Cuenta regresiva -->
        <div class="countdownBlock">
          <div class="countdownTitle" id="statusTitle">Bloqueado por ahora</div>
          <div class="timer" id="countdown">--d : --h : --m : --s</div>
          <p class="hint" id="statusHint">Se habilita el <span id="unlockDateText"></span> (hora de Chile).</p>
        </div>

        <div class="divider"></div>

        <!-- Saludo + canje -->
        <h2 class="greeting">‚ù§Ô∏è Hola, <span class="name" id="recipientName">Daniela Cataldo</span></h2>
        <p class="hint" style="max-width: 56ch; margin-top: -2px;">
          Escribe tu c√≥digo secreto cuando est√© disponible y abre tu vale.
        </p>

        <div class="box">
          <div>
            <label for="codigoInput">C√≥digo secreto</label>
            <input id="codigoInput" type="text" placeholder="Ej: AMOR2025" autocomplete="off" />
            <p id="redeemError" class="error"></p>
          </div>

          <div class="row">
            <button class="btn btn-primary" id="btnRedeem" onclick="canjearCupon()">Canjear cup√≥n</button>
            <button class="btn btn-ghost" onclick="resetPantalla()">Reiniciar</button>
            <span class="badge" id="redeemStateBadge" style="display:none;">‚úî Canjeado en este dispositivo</span>
          </div>

          <div class="coupon" id="resultado">
            <h2 id="tituloRegalo">üéÅ Cup√≥n canjeado</h2>
            <p id="descripcionRegalo"></p>
            <p class="fine">Con cari√±o, <span id="senderName">Gelo</span> üíó</p>
          </div>
        </div>

        <div class="adminBar">
          <button class="btn btn-ghost adminBtn" id="adminBtn" onclick="abrirAdmin()">Admin</button>
        </div>

        <div class="adminPanel" id="adminPanel">
          <div class="labelRow">
            <div>
              <strong style="font-size:0.98rem;">Panel admin</strong>
              <p class="hint" style="margin:4px 0 0;">Prueba estados, cupones y efectos.</p>
            </div>
            <button class="btn btn-ghost adminBtn" onclick="cerrarAdmin()">Cerrar</button>
          </div>

          <div class="subgrid" style="margin-top:8px;">
            <div>
              <label for="adminStateSelect">Estado de prueba</label>
              <select id="adminStateSelect" onchange="setAdminState(this.value)">
                <option value="auto">Autom√°tico (normal)</option>
                <option value="unlocked">Forzar desbloqueado</option>
                <option value="locked">Forzar bloqueado</option>
                <option value="expired">Forzar expirado</option>
              </select>
              <p class="hint" style="margin-top:6px;">No cambia fechas reales, solo simula para probar.</p>
            </div>

            <div class="row" style="gap:8px; margin-top:4px;">
              <button class="btn btn-ghost" onclick="probarAnimaciones()">Animaciones</button>
              <button class="btn btn-ghost" onclick="lanzarConfeti()">Confeti</button>
              <button class="btn btn-ghost" onclick="probarCanjeDemo()">Probar canje</button>
            </div>

            <div class="divider" style="margin:10px 0;"></div>

            <div>
              <label for="adminCodeInput">Cup√≥n (crear/editar r√°pido)</label>
              <div class="subgrid">
                <input id="adminCodeInput" type="text" placeholder="C√≥digo (ej: PRUEBA)" />
                <input id="adminTitleInput" type="text" placeholder="T√≠tulo mostrado" />
                <input id="adminDescInput" type="text" placeholder="Descripci√≥n" />
              </div>
              <div class="row" style="gap:8px; margin-top:8px;">
                <button class="btn btn-primary" onclick="guardarCuponAdmin()">Guardar cup√≥n</button>
                <button class="btn btn-ghost" onclick="llevarAlInput()">Llevar al input</button>
              </div>
              <p id="adminMsg" class="hint" style="margin-top:6px;"></p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="lokiOverlay" id="lokiOverlay" aria-live="polite">
    <div class="mask">
      <canvas id="pixelCanvas"></canvas>
      <div class="label">Transformaci√≥n lista</div>
    </div>
  </div>

  <!-- Confetti (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    /************************************************************
     * CONFIG R√ÅPIDA
     ************************************************************/
    const RECIPIENT_FULL_NAME = "Daniela Cataldo";
    const SENDER_NAME = "Gelo";
    const ADMIN_PIN = "311531311531"; // c√°mbialo si quieres
    const TRANSFORM_SECONDS = 10; // cuenta regresiva tras canjear

    // Se habilita desde el 31 de diciembre (Chile -03:00)
    const UNLOCK_AT_ISO = "2025-12-31T00:00:00-03:00";

    // Expiraci√≥n opcional (si no quieres, deja null)
    const EXPIRES_AT_ISO = null;

    // C√≥digos
    const CUPONES = {
      "AVY JORRAELAN": {
        titulo: "üéÅ Daniela, tu cup√≥n est√° listo",
        descripcion: "V√°lido por un regalo especial. T√∫ lo canjeas y yo lo cumplo sin excusas ‚ú®"
      }
    };

    /************************************************************
     * INIT TEXT
     ************************************************************/
    document.getElementById("recipientName").textContent = RECIPIENT_FULL_NAME;
    document.getElementById("pageTitle").textContent = `Un vale para ${RECIPIENT_FULL_NAME.split(" ")[0]} ‚ú®`;
    document.getElementById("senderName").textContent = SENDER_NAME;

    /************************************************************
     * COUNTDOWN LOGIC
     ************************************************************/
    const LS_REDEEM_KEY = "vale_regalo_redeemed_v4";
    let adminStateOverride = "auto"; // auto | unlocked | locked | expired

    const unlockAt = new Date(UNLOCK_AT_ISO);
    const expiresAt = EXPIRES_AT_ISO ? new Date(EXPIRES_AT_ISO) : null;

    const pillText = document.getElementById("pillText");
    const countdownEl = document.getElementById("countdown");
    const statusTitle = document.getElementById("statusTitle");
    const statusHint = document.getElementById("statusHint");
    const unlockDateText = document.getElementById("unlockDateText");
    const btnRedeem = document.getElementById("btnRedeem");
    const codigoInput = document.getElementById("codigoInput");
    const adminPanel = document.getElementById("adminPanel");
    const adminBtn = document.getElementById("adminBtn");
    const adminMsg = document.getElementById("adminMsg");
    const adminStateSelect = document.getElementById("adminStateSelect");
    const adminCodeInput = document.getElementById("adminCodeInput");
    const adminTitleInput = document.getElementById("adminTitleInput");
    const adminDescInput = document.getElementById("adminDescInput");
    const lokiOverlay = document.getElementById("lokiOverlay");
    const pageEl = document.querySelector(".page");

    function fmtCL(date){
      try{
        return new Intl.DateTimeFormat("es-CL", { dateStyle:"full", timeStyle:"short" }).format(date);
      }catch(_){
        return date.toLocaleString();
      }
    }
    function now(){ return new Date(); }
    function isUnlocked(){
      if (adminStateOverride === "unlocked") return true;
      if (adminStateOverride === "locked") return false;
      return now().getTime() >= unlockAt.getTime();
    }
    function isExpired(){
      if (adminStateOverride === "expired") return true;
      return expiresAt ? now().getTime() > expiresAt.getTime() : false;
    }
    function pad2(n){ return String(n).padStart(2,"0"); }

    unlockDateText.textContent = fmtCL(unlockAt);

    function renderCountdown(){
      if (isExpired()){
        statusTitle.textContent = "Este vale expir√≥";
        countdownEl.textContent = "Expirado";
        statusHint.textContent = "Si quieres, cambia la fecha de expiraci√≥n en el c√≥digo.";
        pillText.textContent = "Ups‚Ä¶";
        btnRedeem.disabled = true;
        codigoInput.disabled = true;
        return;
      }

      if (!isUnlocked()){
        const diff = unlockAt.getTime() - now().getTime();
        const s = Math.max(0, Math.floor(diff / 1000));
        const d = Math.floor(s / 86400);
        const h = Math.floor((s % 86400) / 3600);
        const m = Math.floor((s % 3600) / 60);
        const ss = s % 60;

        statusTitle.textContent = "Bloqueado por ahora";
        countdownEl.textContent = `${pad2(d)}d : ${pad2(h)}h : ${pad2(m)}m : ${pad2(ss)}s`;
        statusHint.innerHTML = `Se habilita el <span>${fmtCL(unlockAt)}</span> (hora de Chile).`;
        pillText.textContent = "Falta poquito‚Ä¶";
        btnRedeem.disabled = true;
        codigoInput.disabled = true;
        return;
      }

      statusTitle.textContent = "Ya puedes canjearlo";
      countdownEl.textContent = "Listo ‚ú®";
      statusHint.textContent = expiresAt ? `Ojo: expira el ${fmtCL(expiresAt)}.` : "Escribe tu c√≥digo secreto y abre tu vale.";
      pillText.textContent = "Disponible üíó";
      btnRedeem.disabled = false;
      codigoInput.disabled = false;
    }

    setInterval(renderCountdown, 1000);
    renderCountdown();

    /************************************************************
     * REDEEM LOGIC
     ************************************************************/
    const redeemError = document.getElementById("redeemError");
    const resultado = document.getElementById("resultado");
    const tituloRegalo = document.getElementById("tituloRegalo");
    const descripcionRegalo = document.getElementById("descripcionRegalo");
    const redeemStateBadge = document.getElementById("redeemStateBadge");

    function lanzarConfeti(){
      try{
        confetti({
          particleCount: 160,
          spread: 80,
          origin: { y: 0.65 },
          scalar: 1.05,
          colors: ["#ff2d6d", "#ff8fb2", "#ffffff"]
        });
      }catch(_){}
    }

    function markRedeemed(){
      localStorage.setItem(LS_REDEEM_KEY, JSON.stringify({ redeemedAt: new Date().toISOString() }));
      redeemStateBadge.style.display = "inline-flex";
    }

    function checkRedeemed(){
      const v = localStorage.getItem(LS_REDEEM_KEY);
      redeemStateBadge.style.display = v ? "inline-flex" : "none";
    }
    checkRedeemed();

    function canjearCupon(){
      redeemError.textContent = "";

      if (!isUnlocked()){
        redeemError.textContent = "Todav√≠a no‚Ä¶ espera al contador ‚ù§Ô∏è";
        return;
      }
      if (isExpired()){
        redeemError.textContent = "Este vale ya expir√≥ ü•≤";
        return;
      }

      const codigo = codigoInput.value.trim().toUpperCase();
      if (!codigo){
        redeemError.textContent = "Escribe un c√≥digo para canjear ‚ú®";
        return;
      }

      const cup = CUPONES[codigo];
      if (!cup){
        redeemError.textContent = "Ese c√≥digo no es v√°lido, intenta de nuevo ‚ù§Ô∏è";
        return;
      }

      tituloRegalo.textContent = cup.titulo || `üéÅ ${RECIPIENT_FULL_NAME}, tu vale est√° listo`;
      descripcionRegalo.textContent = cup.descripcion || "";
      resultado.style.display = "block";
      lanzarConfeti();
      markRedeemed();
      startTransformCountdown();
    }

    function resetPantalla(){
      codigoInput.value = "";
      redeemError.textContent = "";
      resultado.style.display = "none";
    }

    /************************************************************
     * ADMIN PANEL (pruebas)
     ************************************************************/
    function abrirAdmin(){
      const pin = prompt("PIN admin");
      if (pin === ADMIN_PIN){
        adminPanel.style.display = "block";
        adminBtn.textContent = "Admin activo";
        mostrarAdminMsg("Admin activado. Ya puedes probar.", true);
      }else if(pin){
        mostrarAdminMsg("PIN incorrecto.", false);
      }
    }

    function cerrarAdmin(){
      adminPanel.style.display = "none";
      adminBtn.textContent = "Admin";
      adminStateOverride = "auto";
      if (adminStateSelect) adminStateSelect.value = "auto";
      renderCountdown();
      mostrarAdminMsg("", true);
    }

    function setAdminState(val){
      adminStateOverride = val;
      renderCountdown();
      const map = {
        auto: "Estado autom√°tico restaurado.",
        unlocked: "Forzado desbloqueado (pruebas).",
        locked: "Forzado bloqueado.",
        expired: "Forzado expirado."
      };
      mostrarAdminMsg(map[val] || "", true);
    }

    function mostrarAdminMsg(msg, ok=true){
      if (!adminMsg) return;
      adminMsg.textContent = msg || "";
      adminMsg.className = ok ? "success" : "error";
    }

    function guardarCuponAdmin(){
      const code = adminCodeInput.value.trim().toUpperCase();
      const title = adminTitleInput.value.trim();
      const desc = adminDescInput.value.trim();
      if (!code){
        mostrarAdminMsg("Escribe un c√≥digo para crear/editar.", false);
        return;
      }
      CUPONES[code] = {
        titulo: title || `üéÅ ${RECIPIENT_FULL_NAME}, tu vale`,
        descripcion: desc || "Cup√≥n creado desde admin."
      };
      mostrarAdminMsg(`Cup√≥n ${code} listo.`, true);
    }

    function llevarAlInput(){
      const code = adminCodeInput.value.trim().toUpperCase();
      if (code){
        codigoInput.value = code;
        mostrarAdminMsg(`C√≥digo ${code} listo en el input.`, true);
      }else{
        mostrarAdminMsg("Escribe un c√≥digo para llevarlo al input.", false);
      }
    }

    function probarCanjeDemo(){
      const code = adminCodeInput.value.trim().toUpperCase() || Object.keys(CUPONES)[0] || "AMOR2025";
      codigoInput.value = code;
      canjearCupon();
    }

    function probarAnimaciones(){
      lanzarConfeti();
    }

    /************************************************************
     * TRANSFORMACI√ìN: cuenta regresiva + Loki
     ************************************************************/
    let heartMode = "heart"; // heart | countdown | loki
    let transformEndsAt = null;
    let pixelRAF = null;

    function startTransformCountdown(){
      heartMode = "countdown";
      window.__lokiTriggered = false;
      transformEndsAt = performance.now() + (TRANSFORM_SECONDS * 1000);
    }

    function triggerLokiOverlay(){
      heartMode = "loki";
      document.body.classList.add("blackout");
      pageEl.classList.add("fadeOut");
      lokiOverlay.classList.add("show");
      startPixelD();
    }

    /************************************************************
     * PIXEL HEART PRO (Canvas)
     * - Part√≠culas que se forman en un coraz√≥n (relleno)
     * - Latido con elasticidad + swirl/curl field
     * - Trail suave + destellos + ‚Äúbloom‚Äù (se dispersa y re-forma)
     ************************************************************/
    const canvas = document.getElementById("heartCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // dibuja en CSS px
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    /** Coraz√≥n impl√≠cito: (x^2 + y^2 - 1)^3 - x^2 y^3 <= 0 */
    function insideHeart(x, y){
      const a = x*x + y*y - 1;
      return (a*a*a - x*x*y*y*y) <= 0;
    }

    /** Genera puntos dentro del coraz√≥n (relleno) en coords ~[-1.3..1.3] */
    function buildFilledHeartPoints(count = 900){
      const pts = [];
      let tries = 0;
      while (pts.length < count && tries < count * 50){
        tries++;
        const x = (Math.random() * 2.8) - 1.4;
        const y = (Math.random() * 2.8) - 1.4;
        if (insideHeart(x, y)){
          // ‚Äúestira‚Äù un poquito para est√©tica (coraz√≥n m√°s alto)
          pts.push({ x: x * 1.06, y: y * 1.12 });
        }
      }
      return pts;
    }

    /** Un poquito de pseudo-ruido suave */
    function wobble(t, seed){
      return Math.sin(t * 0.9 + seed) * 0.6 + Math.sin(t * 2.3 + seed * 1.7) * 0.35;
    }

    /** Part√≠culas */
    const HEART_POINTS = buildFilledHeartPoints(1500);

    const PARTICLE_COUNT = 1350;
    const particles = Array.from({ length: PARTICLE_COUNT }, (_, i) => ({
      // posiciones en px (se ajustan al centro en init)
      x: 0, y: 0,
      vx: 0, vy: 0,
      // asignaci√≥n a punto del coraz√≥n
      idx: Math.floor(Math.random() * HEART_POINTS.length),
      // semilla para wobble / brillo
      seed: Math.random() * 1000,
      // ‚Äútama√±o‚Äù individual
      s: 0.9 + Math.random() * 0.9
    }));

    /** Estado ‚Äúbloom‚Äù (dispersi√≥n y regreso) */
    let bloom = 0;          // 0..1
    let bloomDir = 0;       // -1,0,1
    let nextBloomAt = performance.now() + 8500 + Math.random() * 4500;

    function scheduleBloom(){
      nextBloomAt = performance.now() + 8500 + Math.random() * 6500;
    }

    /** Inicializa part√≠culas al centro */
    function initParticles(){
      const rect = canvas.getBoundingClientRect();
      const cx = rect.width * 0.5;
      const cy = rect.height * 0.56;
      for (const p of particles){
        p.x = cx + (Math.random() - 0.5) * 18;
        p.y = cy + (Math.random() - 0.5) * 18;
        p.vx = (Math.random() - 0.5) * 0.6;
        p.vy = (Math.random() - 0.5) * 0.6;
      }
    }
    initParticles();

    function startPixelD(){
      cancelAnimationFrame(pixelRAF);
      resizePixelCanvas();
      pixelRAF = requestAnimationFrame(drawPixelD);
    }

    const pixelCanvas = document.getElementById("pixelCanvas");
    const pixelCtx = pixelCanvas.getContext("2d");

    function resizePixelCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = pixelCanvas.getBoundingClientRect();
      pixelCanvas.width = Math.floor(rect.width * dpr);
      pixelCanvas.height = Math.floor(rect.height * dpr);
      pixelCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function buildDPoints(count=3600){
      const pts = [];
      let tries = 0;
      while (pts.length < count && tries < count*80){
        tries++;
        const x = (Math.random()*2) - 1; // -1..1
        const y = (Math.random()*2) - 1;
        const outer = ((x + 0.35)**2 + y*y) <= 1.0;
        const inner = ((x + 0.35)**2 + y*y) <= 0.55**2;
        const bar = (x <= -0.35 && Math.abs(y) <= 1);
        if (bar || (outer && !inner && x > -0.35)){
          pts.push({x, y});
        }
      }
      return pts;
    }

    const D_POINTS = buildDPoints(3600);

    function drawPixelD(time){
      const w = pixelCanvas.getBoundingClientRect().width;
      const h = pixelCanvas.getBoundingClientRect().height;
      const t = time * 0.001;

      pixelCtx.clearRect(0,0,w,h);
      const beat = 1 + 0.08 * Math.sin(t*2.4) + 0.03 * Math.sin(t*4.1);
      const scale = Math.min(w,h) * 0.46 * beat;
      const pxBase = Math.max(1, Math.round(Math.min(w,h) / 180));
      const px = Math.max(1, Math.round(pxBase * (0.9 + 0.12*(beat-1)/0.08)));
      const cx = w * 0.5;
      const cy = h * 0.5;

      pixelCtx.fillStyle = "#0b0b0f";
      pixelCtx.fillRect(0,0,w,h);

      pixelCtx.shadowColor = "rgba(10, 198, 133, 0.35)";
      pixelCtx.shadowBlur = 18;
      pixelCtx.fillStyle = "#0ac685";

      for (const p of D_POINTS){
        const x = cx + p.x * scale;
        const y = cy + p.y * scale;
        const gx = Math.round(x / px) * px;
        const gy = Math.round(y / px) * px;
        pixelCtx.fillRect(gx, gy, px, px);
      }

      pixelCtx.shadowBlur = 0;
      pixelRAF = requestAnimationFrame(drawPixelD);
    }

    function draw(time){
      const rect = canvas.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      const t = time * 0.001;

      // Trail transparente (aten√∫a frame anterior sin colorear)
      ctx.save();
      ctx.globalCompositeOperation = "destination-out";
      ctx.fillStyle = "rgba(0,0,0,0.16)";
      ctx.fillRect(0, 0, w, h);
      ctx.restore();

      if (heartMode === "countdown"){
        ctx.clearRect(0,0,w,h);

        const msLeft = transformEndsAt - performance.now();
        const remaining = Math.max(0, Math.ceil(msLeft / 1000));

        ctx.fillStyle = "rgba(0,0,0,0.65)";
        ctx.fillRect(0,0,w,h);

        ctx.fillStyle = "#ff2d6d";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = `800 ${Math.min(w,h) * 0.38}px Inter, sans-serif`;
        ctx.fillText(String(remaining), w/2, h/2);

        if (remaining === 0){
          if (!window.__lokiTriggered){
            window.__lokiTriggered = true;
            setTimeout(triggerLokiOverlay, 350);
          }
        }

        requestAnimationFrame(draw);
        return;
      }

      if (heartMode === "loki"){
        ctx.clearRect(0,0,w,h);
        return;
      }

      // Latido ‚Äúcomplejo‚Äù (doble pulso)
      const beatA = Math.sin(t * 2.35);
      const beatB = Math.sin(t * 4.7 + 0.6) * 0.35;
      const beat = 1 + 0.065 * beatA + 0.025 * beatB;

      // Ajuste de tama√±o del coraz√≥n (se adapta al contenedor)
      const baseScale = Math.min(w, h) * 0.36;
      const scale = baseScale * beat;

      // Pixel size adaptativo (m√°s peque√±o)
      const pxBase = Math.max(1, Math.round(Math.min(w,h) / 110));
      const px = Math.max(1, Math.round(pxBase * (0.92 + 0.10 * (beat - 1) / 0.065)));

      // Centro del coraz√≥n
      const cx = w * 0.5;
      const cy = h * 0.58;

      // Bloom trigger
      if (performance.now() > nextBloomAt && bloomDir === 0){
        bloomDir = 1; // inicia dispersi√≥n
      }
      if (bloomDir === 1){
        bloom += 0.018;
        if (bloom >= 1){
          bloom = 1;
          bloomDir = -1; // vuelve a formar
        }
      } else if (bloomDir === -1){
        bloom -= 0.010;
        if (bloom <= 0){
          bloom = 0;
          bloomDir = 0;
          scheduleBloom();
        }
      }

      // Colores (respiran con el beat)
      const alpha = 0.72 + 0.12 * (0.5 + 0.5 * beatA);
      const fill = `rgba(255, 45, 109, ${alpha.toFixed(3)})`;
      const glow = `rgba(255, 143, 178, ${(0.12 + 0.10*(0.5+0.5*beatA)).toFixed(3)})`;

      // Glow sutil
      ctx.shadowColor = glow;
      ctx.shadowBlur = 18;

      // Dibuja un ‚Äúring‚Äù sutil al latir (estilo aura)
      const ringAlpha = 0.08 + 0.08 * Math.max(0, beatA);
      ctx.beginPath();
      ctx.strokeStyle = `rgba(255,45,109,${ringAlpha.toFixed(3)})`;
      ctx.lineWidth = 2;
      ctx.arc(cx, cy - scale*0.10, scale*0.78, 0, Math.PI*2);
      ctx.stroke();

      // F√≠sica de part√≠culas
      // - cada part√≠cula va hacia su target (punto del coraz√≥n)
      // - swirl/curl field alrededor del centro
      // - bloom empuja hacia afuera
      const kAttract = 0.028;       // fuerza hacia target
      const damping = 0.86;         // freno
      const swirl = 0.0017;         // rotaci√≥n suave
      const jitter = 0.12;          // micro-vibraci√≥n

      // Para l√≠neas suaves entre part√≠culas cercanas (barato: sample)
      const connectEvery = 8;
      const maxLinkDist = Math.min(w,h) * 0.08;

      ctx.fillStyle = fill;

      // Precalcula un subconjunto para l√≠neas
      const linkIndices = [];
      for (let i = 0; i < particles.length; i += connectEvery) linkIndices.push(i);

      // Actualiza part√≠culas + dibuja pixel
      for (let i = 0; i < particles.length; i++){
        const p = particles[i];
        const hp = HEART_POINTS[p.idx];

        // Target en px (relleno). Ajuste: invertir Y.
        // wobble hace el coraz√≥n ‚Äúorg√°nico‚Äù
        const wobX = wobble(t, p.seed) * 0.55;
        const wobY = wobble(t + 0.7, p.seed) * 0.55;

        const tx = cx + (hp.x * scale) + wobX;
        const ty = cy - (hp.y * scale) + wobY;

        // Fuerza hacia target
        let ax = (tx - p.x) * kAttract;
        let ay = (ty - p.y) * kAttract;

        // Swirl alrededor del centro (campo rotacional)
        const dx = p.x - cx;
        const dy = p.y - (cy - scale*0.08);
        ax += -dy * swirl;
        ay +=  dx * swirl;

        // Bloom: empuja hacia afuera y luego deja que vuelva
        if (bloom > 0){
          const dist = Math.sqrt(dx*dx + dy*dy) + 0.001;
          const push = bloom * (0.55 + 0.35*Math.sin(t*3 + p.seed));
          ax += (dx / dist) * push;
          ay += (dy / dist) * push;
        }

        // Micro jitter (vibra pixel)
        ax += (Math.random() - 0.5) * jitter * 0.02;
        ay += (Math.random() - 0.5) * jitter * 0.02;

        // Integraci√≥n
        p.vx = (p.vx + ax) * damping;
        p.vy = (p.vy + ay) * damping;

        p.x += p.vx;
        p.y += p.vy;

        // Pixel-grid: snap a grilla
        const gx = Math.round(p.x / px) * px;
        const gy = Math.round(p.y / px) * px;

        // Tama√±o individual con respiraci√≥n
        const s = Math.max(1, Math.round(px * p.s * (0.88 + 0.18*(beat - 1) / 0.065)));
        ctx.fillRect(gx, gy, s, s);

        // Destellos raros
        if (Math.random() < 0.0035){
          ctx.fillStyle = `rgba(255,255,255,0.75)`;
          ctx.fillRect(gx, gy, Math.max(1, Math.round(s*0.8)), Math.max(1, Math.round(s*0.8)));
          ctx.fillStyle = fill;
        }

        // Re-asignaci√≥n ocasional del punto para ‚Äúreacomodo‚Äù (solo cuando bloom est√° activo)
        if (bloom > 0.4 && Math.random() < 0.003){
          p.idx = Math.floor(Math.random() * HEART_POINTS.length);
        }
      }

      // L√≠neas sutiles (conecta algunos puntos cercanos, casi imperceptible)
      ctx.shadowBlur = 0;
      ctx.lineWidth = 1;
      ctx.strokeStyle = `rgba(255,45,109,0.08)`;
      for (let a = 0; a < linkIndices.length; a++){
        const i = linkIndices[a];
        const p1 = particles[i];
        for (let b = a + 1; b < linkIndices.length; b++){
          const j = linkIndices[b];
          const p2 = particles[j];
          const dx = p1.x - p2.x;
          const dy = p1.y - p2.y;
          const d2 = dx*dx + dy*dy;
          if (d2 < maxLinkDist*maxLinkDist){
            const d = Math.sqrt(d2);
            const k = 1 - (d / maxLinkDist);
            ctx.strokeStyle = `rgba(255,45,109,${(0.03 + 0.10*k).toFixed(3)})`;
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
          }
        }
      }

      requestAnimationFrame(draw);
    }

    // Limpieza inicial para que el trail no parta ‚Äúsucio‚Äù
    (function prime(){
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
    })();
    requestAnimationFrame(draw);
  </script>
</body>
</html>
